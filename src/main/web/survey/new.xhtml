<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
        PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xml:lang="en" lang="en">
<h:head>
    <h:outputStylesheet name="css/style.css" />
    <title>Edit survey</title>
</h:head>
<h:body rendered="#{userController.getUser().getEmail() != null}">
    <h1>Edit survey</h1>
    <!-- Change survey title and description -->
    <h:form id="survey">
        <p:panelGrid id="infoGrid" styleClass="surveyPanel" columns="2">
            <p:outputLabel for="title" value="Survey title"/>
            <p:column>
                <p:inputText id="title"
                             required="#{param['survey:save'] != null}"
                             value="#{newSurveyController.survey.title}"
                             maxlength="80"
                             size="80"
                             placeholder="Survey title"
                             styleClass="newSurveyField"/>
                <p:message for="title"/>
            </p:column>
            <p:column>
            <p:outputLabel for="description" value="Survey description" />
        </p:column>
            <p:column>
                <p:inputTextarea id="description"
                                 value="#{newSurveyController.survey.description}"
                                 rows="6" cols="80"
                                 placeholder="Survey description (Optional)"
                                 styleClass="newSurveyField"/>
                <p:message for="description"/>
            </p:column>
            <p:column>
                <p:outputLabel for="isPublic" value="Survey results public" />
            </p:column>
            <p:column>
                <p:selectBooleanCheckbox id="isPublic"
                                 value="#{newSurveyController.survey.isPublic}"/>
                <p:message for="isPublic"/>
            </p:column>
        </p:panelGrid>

        <!-- New question -->
        <c:if test="#{newSurveyController.surveyCreationStep == 'QUESTION_TYPE_CHOICE'}">
            <!-- Choose new question type -->
            <ui:include src="/WEB-INF/questions/new-question.xhtml"/>
        </c:if>

        <!-- Preview already created survey - questions and choices -->
        <c:if test="#{not empty newSurveyController.survey.questions}">
            <h3>Questions</h3>
            <h:panelGroup id="questions">
                <ui:repeat value="#{newSurveyController.survey.questions}" var="question">
                    <h:panelGroup>
                        <h:panelGroup rendered="#{question['class'].simpleName == 'FreeTextQuestion'}">
                            <ui:include src="/WEB-INF/questions/preview/text-preview.xhtml">
                                <ui:param name="question" value="#{question}"/>
                            </ui:include>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{question['class'].simpleName == 'IntervalQuestion'}">
                            <ui:include src="/WEB-INF/questions/preview/interval-preview.xhtml">
                                <ui:param name="question" value="#{question}"/>
                            </ui:include>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{question['class'].simpleName == 'SingleChoiceQuestion'}">
                            <ui:include src="/WEB-INF/questions/preview/single-choice-preview.xhtml">
                                <ui:param name="question" value="#{question}"/>
                            </ui:include>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{question['class'].simpleName == 'MultipleChoiceQuestion'}">
                            <ui:include src="/WEB-INF/questions/preview/multi-choice-preview.xhtml">
                                <ui:param name="question" value="#{question}"/>
                            </ui:include>
                        </h:panelGroup>
                        <c:if test="#{newSurveyController.surveyCreationStep == 'QUESTION_TYPE_CHOICE'}">
                            <p:commandButton value="Edit question" immediate="true"
                                             actionListener="#{newSurveyController.editQuestion(question)}"
                                             ajax="true"
                                             update="survey"
                                             styleClass="previewPanel"/>
                        </c:if>
                        <p:commandButton value="Remove question" immediate="true"
                                         actionListener="#{newSurveyController.removeQuestion(question)}"
                                         ajax="true"
                                         update="survey"/>
                        <br/>
                    </h:panelGroup>
                </ui:repeat>
            </h:panelGroup>
        </c:if>

        <c:if test="#{newSurveyController.surveyCreationStep == 'NEW_QUESTION'}">
            <!-- Create new question -->
            <ui:include src="/WEB-INF/questions/edit/#{newSurveyController.newQuestionType}-edit.xhtml"/>
            <br/>
            <p:commandButton value="Cancel"
                             id="cancelNew"
                             action="#{newSurveyController.cancel}"
                             update="survey"/>
        </c:if>
        <c:if test="#{newSurveyController.surveyCreationStep == 'EDIT_QUESTION'}">
            <h:panelGroup>
                <h:panelGroup rendered="#{newSurveyController.questionToEdit['class'].simpleName == 'FreeTextQuestion'}">
                    <ui:include src="/WEB-INF/questions/edit/text-edit.xhtml"/>
                </h:panelGroup>
                <h:panelGroup rendered="#{newSurveyController.questionToEdit['class'].simpleName == 'IntervalQuestion'}">
                    <ui:include src="/WEB-INF/questions/edit/interval-edit.xhtml"/>
                </h:panelGroup>
                <h:panelGroup rendered="#{newSurveyController.questionToEdit['class'].simpleName == 'SingleChoiceQuestion'}">
                    <ui:include src="/WEB-INF/questions/edit/single-choice-edit.xhtml"/>
                </h:panelGroup>
                <h:panelGroup rendered="#{newSurveyController.questionToEdit['class'].simpleName == 'MultipleChoiceQuestion'}">
                    <ui:include src="/WEB-INF/questions/edit/multi-choice-edit.xhtml"/>
                </h:panelGroup>
            </h:panelGroup>
            <br/>
            <p:commandButton value="Cancel"
                             id="cancelEdit"
                             action="#{newSurveyController.cancel}"
                             update="survey"/>
        </c:if>
        <p:dialog modal="true" header="Edit conflict" widgetVar="oleDialog" closable="true" resizable="false" closeOnEscape="true">
            <p:panelGrid columns="2">
                <h:panelGroup>
                    <h3>Current data</h3>
                    #{newSurveyController.survey.title}<br/>
                    #{newSurveyController.survey.description}<br/>
                    Expires #{newSurveyController.survey.expirationTime.toGMTString()}
                    <h4>Questions</h4>
                    <ui:repeat value="#{newSurveyController.survey.questions}" var="question">
                        <h:panelGroup>
                            <h:panelGroup rendered="#{question['class'].simpleName == 'FreeTextQuestion'}">
                                <ui:include src="/WEB-INF/questions/preview/text-preview.xhtml">
                                    <ui:param name="question" value="#{question}"/>
                                </ui:include>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{question['class'].simpleName == 'IntervalQuestion'}">
                                <ui:include src="/WEB-INF/questions/preview/interval-preview.xhtml">
                                    <ui:param name="question" value="#{question}"/>
                                </ui:include>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{question['class'].simpleName == 'SingleChoiceQuestion'}">
                                <ui:include src="/WEB-INF/questions/preview/single-choice-preview.xhtml">
                                    <ui:param name="question" value="#{question}"/>
                                </ui:include>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{question['class'].simpleName == 'MultipleChoiceQuestion'}">
                                <ui:include src="/WEB-INF/questions/preview/multi-choice-preview.xhtml">
                                    <ui:param name="question" value="#{question}"/>
                                </ui:include>
                            </h:panelGroup>
                            <br/>
                        </h:panelGroup>
                    </ui:repeat>
                </h:panelGroup>
                <h:panelGroup>
                    <h3>Conflicting data</h3>
                    #{newSurveyController.conflictingSurvey.title}<br/>
                    #{newSurveyController.conflictingSurvey.description}<br/>
                    Expires #{newSurveyController.conflictingSurvey.expirationTime.toGMTString()}
                    <h4>Questions</h4>
                    <ui:repeat value="#{newSurveyController.conflictingSurvey.questions}" var="question">
                        <h:panelGroup>
                            <h:panelGroup rendered="#{question['class'].simpleName == 'FreeTextQuestion'}">
                                <ui:include src="/WEB-INF/questions/preview/text-preview.xhtml">
                                    <ui:param name="question" value="#{question}"/>
                                </ui:include>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{question['class'].simpleName == 'IntervalQuestion'}">
                                <ui:include src="/WEB-INF/questions/preview/interval-preview.xhtml">
                                    <ui:param name="question" value="#{question}"/>
                                </ui:include>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{question['class'].simpleName == 'SingleChoiceQuestion'}">
                                <ui:include src="/WEB-INF/questions/preview/single-choice-preview.xhtml">
                                    <ui:param name="question" value="#{question}"/>
                                </ui:include>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{question['class'].simpleName == 'MultipleChoiceQuestion'}">
                                <ui:include src="/WEB-INF/questions/preview/multi-choice-preview.xhtml">
                                    <ui:param name="question" value="#{question}"/>
                                </ui:include>
                            </h:panelGroup>
                            <br/>
                        </h:panelGroup>
                    </ui:repeat>
                </h:panelGroup>
            </p:panelGrid>

            <p:commandButton id="overwrite"
                             value="Overwrite"
                             action="#{newSurveyController.overwrite()}"
                             update="survey"
                             oncomplete="if (args &amp;&amp; !args.validationFailed) PF('oleDialog').hide()"/>
            <p:commandButton id="refresh"
                             value="Refresh and edit"
                             actionListener="#{newSurveyController.refresh()}"
                             update="survey"
                             oncomplete="PF('oleDialog').hide()"/>

            <p:commandButton id="cancel"
                             value="Cancel editing"
                             action="#{newSurveyController.cancelEdit()}"
                             update="survey"
                             ajax="false"/>

        </p:dialog>

        <h3>Set expiration</h3>
        <h:panelGrid columns="3">
            <p:outputLabel for="expiration_date" value="Expiration date "/>
            <p:inputText type="date" id="expiration_date" value="#{newSurveyController.expirationDateString}"/>
            <p:message for="expiration_date"/>

            <p:outputLabel for="expiration_time" value="Expiration time "/>
            <p:inputText type="time" id="expiration_time" value="#{newSurveyController.expirationTimeString}"/>
            <p:message for="expiration_time"/>
        </h:panelGrid>

        <!-- Save survey and show url in new page-->
        <br/>
        <p:messages globalOnly="true"/>
        <br/>
        <p:commandButton id="save"
                         value="Save survey"
                         action="#{newSurveyController.saveSurvey()}"
                         ajax="false"
                         update="survey"/>

    </h:form>
</h:body>
<c:if test="#{userController.getUser().getEmail() == null}">
    <body>
        <h1>ERROR 401: Unauthorized</h1>
    </body>
</c:if>
</html>